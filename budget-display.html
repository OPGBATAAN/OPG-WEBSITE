<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 AIP Budget - Office of the Provincial Governor</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            background: #f0f0f0;
            padding: 20px;
        }
        
        .budget-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .budget-header {
            background: linear-gradient(135deg, #2c5282 0%, #1a365d 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .budget-title {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .budget-subtitle {
            font-size: 16px;
            opacity: 0.9;
        }
        
        .budget-content {
            padding: 30px;
        }
        
        .section-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .section-card {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .section-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: #2c5282;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
        }
        
        .section-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            background: #ffffff;
        }
        
        .section-card:hover::before {
            transform: translateX(0);
        }
        
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #2c5282;
            margin-bottom: 8px;
        }
        
        .section-description {
            color: #6c757d;
            font-size: 14px;
            margin-bottom: 12px;
        }
        
        .section-stats {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .row-count {
            background: #e3f2fd;
            color: #1976d2;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }
        
        .view-btn {
            background: #2c5282;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }
        
        .view-btn:hover {
            background: #1a365d;
        }
        
        .back-btn {
            background: #6c757d;
            color: white;
            text-decoration: none;
            padding: 10px 20px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 20px;
            transition: background 0.3s ease;
        }
        
        .back-btn:hover {
            background: #5a6268;
        }
        
        .summary-section {
            background: #e8f5e8;
            border: 1px solid #c3e6c3;
            border-radius: 8px;
            padding: 20px;
            margin-top: 30px;
        }

        .analysis-section {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }

        .analysis-title {
            font-size: 20px;
            font-weight: bold;
            color: #2c5282;
            margin-bottom: 12px;
        }

        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 16px;
            margin-top: 12px;
        }

        .analysis-grid + .analysis-grid {
            margin-top: 16px;
        }

        .analysis-card {
            border: 1px solid #e9ecef;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 14px;
        }

        .chart-wrap {
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px;
        }

        .chart-title {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            gap: 10px;
            margin-bottom: 8px;
        }

        .chart-title strong {
            color: #1a365d;
            font-size: 14px;
        }

        .chart-sub {
            color: #6c757d;
            font-size: 12px;
        }

        .chart-canvas {
            width: 100%;
            height: 220px;
            display: block;
        }

        .chart-canvas.small {
            height: 200px;
        }

        @media (max-width: 600px) {
            .chart-canvas {
                height: 240px;
            }

            .chart-canvas.small {
                height: 220px;
            }
        }

        .mini-kpis {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
            margin-top: 12px;
        }

        .kpi {
            background: #ffffff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 10px;
        }

        .kpi .label {
            color: #6c757d;
            font-size: 11px;
            margin-bottom: 4px;
        }

        .kpi .value {
            color: #2c5282;
            font-weight: bold;
            font-size: 15px;
        }

        .analysis-card h4 {
            color: #1a365d;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .analysis-list {
            list-style: none;
            padding-left: 0;
            margin: 0;
        }

        .analysis-list li {
            display: flex;
            justify-content: space-between;
            gap: 10px;
            padding: 6px 0;
            border-bottom: 1px dashed #dee2e6;
            font-size: 12px;
        }

        .analysis-list li:last-child {
            border-bottom: none;
        }

        .pill {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
        }

        .pill-blue {
            background: #e3f2fd;
            color: #1976d2;
        }

        .pill-green {
            background: #e8f5e8;
            color: #155724;
        }

        .pill-gray {
            background: #f1f3f5;
            color: #495057;
        }

        .bar {
            height: 10px;
            background: #e9ecef;
            border-radius: 999px;
            overflow: hidden;
            margin-top: 8px;
        }

        .bar > div {
            height: 100%;
            background: linear-gradient(90deg, #2c5282 0%, #4a90e2 100%);
            width: 0;
        }

        .insights {
            margin-top: 10px;
            color: #495057;
            font-size: 12px;
            line-height: 1.45;
        }
        
        .summary-title {
            font-size: 20px;
            font-weight: bold;
            color: #155724;
            margin-bottom: 15px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #155724;
        }
        
        .stat-label {
            font-size: 14px;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <a href="index.html" class="back-btn">← Back to Website</a>
    
    <div class="budget-container">
        <div class="budget-header">
            <div class="budget-title">2026 AIP Budget</div>
            <div class="budget-subtitle">Quarterly Financial Report of Operations - For the Quarter Ending December 31, 2025</div>
        </div>
        
        <div class="budget-content">
            <div class="section-grid">
                <div class="section-card" onclick="window.location.href='budget_sheet_1.html'">
                    <div class="section-title">Provision of Financial Assistance</div>
                    <div class="section-description">Financial assistance programs and support services</div>
                    <div class="section-stats">
                        <span class="row-count">5 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_2.html'">
                    <div class="section-title">Special Assistance Program</div>
                    <div class="section-description">Special assistance and support programs</div>
                    <div class="section-stats">
                        <span class="row-count">14 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_3.html'">
                    <div class="section-title">Health Promotion Board Services</div>
                    <div class="section-description">Health promotion and wellness programs</div>
                    <div class="section-stats">
                        <span class="row-count">12 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_4.html'">
                    <div class="section-title">Agricultural & Biosystems Engineering</div>
                    <div class="section-description">Agricultural programs and biosystems engineering</div>
                    <div class="section-stats">
                        <span class="row-count">3 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_5.html'">
                    <div class="section-title">Scholarship Grant Program</div>
                    <div class="section-description">Educational scholarships and grants</div>
                    <div class="section-stats">
                        <span class="row-count">13 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_6.html'">
                    <div class="section-title">Internal Auditing Program</div>
                    <div class="section-description">Internal audit and compliance programs</div>
                    <div class="section-stats">
                        <span class="row-count">3 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_7.html'">
                    <div class="section-title">Strategic Management Program</div>
                    <div class="section-description">Strategic planning and management systems</div>
                    <div class="section-stats">
                        <span class="row-count">2 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_8.html'">
                    <div class="section-title">Procurement Management Program</div>
                    <div class="section-description">Procurement processes and supply management</div>
                    <div class="section-stats">
                        <span class="row-count">2 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_9.html'">
                    <div class="section-title">Housing Development Projects</div>
                    <div class="section-description">Housing and infrastructure development</div>
                    <div class="section-stats">
                        <span class="row-count">16 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_10.html'">
                    <div class="section-title">Financial Expenses</div>
                    <div class="section-description">Financial management and debt service</div>
                    <div class="section-stats">
                        <span class="row-count">2 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_11.html'">
                    <div class="section-title">Peace and Order Program</div>
                    <div class="section-description">Peacekeeping and public safety programs</div>
                    <div class="section-stats">
                        <span class="row-count">13 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_12.html'">
                    <div class="section-title">Social and Welfare Development</div>
                    <div class="section-description">Social welfare programs and services</div>
                    <div class="section-stats">
                        <span class="row-count">1 row</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_13.html'">
                    <div class="section-title">Medical and Individual Assistance</div>
                    <div class="section-description">Medical, burial, and individual crisis assistance</div>
                    <div class="section-stats">
                        <span class="row-count">9 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_14.html'">
                    <div class="section-title">Protective Services</div>
                    <div class="section-description">Services for vulnerable and marginalized sectors</div>
                    <div class="section-stats">
                        <span class="row-count">10 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_15.html'">
                    <div class="section-title">Rice Subsidy Program</div>
                    <div class="section-description">Rice subsidy and food assistance programs</div>
                    <div class="section-stats">
                        <span class="row-count">6 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_16.html'">
                    <div class="section-title">20% Development Fund</div>
                    <div class="section-description">Development fund allocation</div>
                    <div class="section-stats">
                        <span class="row-count">1 row</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_17.html'">
                    <div class="section-title">Social Development</div>
                    <div class="section-description">Comprehensive social development programs</div>
                    <div class="section-stats">
                        <span class="row-count">47 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_18.html'">
                    <div class="section-title">Economic Development</div>
                    <div class="section-description">Economic growth and development initiatives</div>
                    <div class="section-stats">
                        <span class="row-count">68 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_19.html'">
                    <div class="section-title">Environmental Management</div>
                    <div class="section-description">Environmental protection and management</div>
                    <div class="section-stats">
                        <span class="row-count">31 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_20.html'">
                    <div class="section-title">Disaster Risk Reduction Fund</div>
                    <div class="section-description">Local disaster risk reduction management</div>
                    <div class="section-stats">
                        <span class="row-count">1 row</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_21.html'">
                    <div class="section-title">70% Disaster Preparedness</div>
                    <div class="section-description">Disaster preparedness programs</div>
                    <div class="section-stats">
                        <span class="row-count">1 row</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_22.html'">
                    <div class="section-title">Disaster Prevention and Mitigation</div>
                    <div class="section-description">Disaster prevention measures</div>
                    <div class="section-stats">
                        <span class="row-count">4 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_23.html'">
                    <div class="section-title">Disaster Preparedness</div>
                    <div class="section-description">Disaster preparedness activities</div>
                    <div class="section-stats">
                        <span class="row-count">15 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_24.html'">
                    <div class="section-title">Disaster Response</div>
                    <div class="section-description">Emergency disaster response</div>
                    <div class="section-stats">
                        <span class="row-count">5 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_25.html'">
                    <div class="section-title">Disaster Recovery</div>
                    <div class="section-description">Disaster recovery and rehabilitation</div>
                    <div class="section-stats">
                        <span class="row-count">16 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_26.html'">
                    <div class="section-title">Disaster Equipment</div>
                    <div class="section-description">Procurement of disaster response equipment</div>
                    <div class="section-stats">
                        <span class="row-count">4 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
                
                <div class="section-card" onclick="window.location.href='budget_sheet_27.html'">
                    <div class="section-title">30% Quick Response</div>
                    <div class="section-description">Quick response disaster fund</div>
                    <div class="section-stats">
                        <span class="row-count">14 rows</span>
                        <button class="view-btn">View Details</button>
                    </div>
                </div>
            </div>
            
            <div class="summary-section">
                <div class="summary-title">Budget Summary</div>
                <div class="summary-stats">
                    <div class="stat-item">
                        <div class="stat-value">30</div>
                        <div class="stat-label">Total Sections</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">359</div>
                        <div class="stat-label">Total Rows</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">19</div>
                        <div class="stat-label">Data Columns</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-value">2026</div>
                        <div class="stat-label">Budget Year</div>
                    </div>
                </div>
            </div>

            <div class="analysis-section" id="budget-analysis">
                <div class="analysis-title">Smart Summary & Analysis</div>
                <div class="insights" id="analysis-insights"></div>

                <div class="mini-kpis" id="analysis-kpis">
                    <div class="kpi"><div class="label">Top section</div><div class="value" id="kpi-top">—</div></div>
                    <div class="kpi"><div class="label">Largest share (Top 5)</div><div class="value" id="kpi-top5">—</div></div>
                    <div class="kpi"><div class="label">Average section size</div><div class="value" id="kpi-avg">—</div></div>
                    <div class="kpi"><div class="label">Median section size</div><div class="value" id="kpi-med">—</div></div>
                </div>

                <div class="analysis-grid">
                    <div class="chart-wrap">
                        <div class="chart-title">
                            <strong>Top Sections</strong>
                            <span class="chart-sub">By line-items (rows)</span>
                        </div>
                        <canvas id="chart-top" class="chart-canvas" width="800" height="220"></canvas>
                    </div>

                    <div class="chart-wrap">
                        <div class="chart-title">
                            <strong>Focus Areas</strong>
                            <span class="chart-sub">Estimated share</span>
                        </div>
                        <canvas id="chart-focus" class="chart-canvas" width="800" height="220"></canvas>
                    </div>

                    <div class="chart-wrap">
                        <div class="chart-title">
                            <strong>Section Size Distribution</strong>
                            <span class="chart-sub">How sections are spread</span>
                        </div>
                        <canvas id="chart-dist" class="chart-canvas small" width="800" height="200"></canvas>
                    </div>
                </div>

                <div class="analysis-grid">
                    <div class="analysis-card">
                        <h4>Largest Sections (by line-items)</h4>
                        <ul class="analysis-list" id="analysis-top-sections"></ul>
                    </div>
                    <div class="analysis-card">
                        <h4>Focus Areas (estimated)</h4>
                        <ul class="analysis-list" id="analysis-focus-areas"></ul>
                    </div>
                    <div class="analysis-card">
                        <h4>Data Distribution</h4>
                        <ul class="analysis-list" id="analysis-distribution"></ul>
                        <div class="bar" aria-hidden="true"><div id="analysis-concentration-bar"></div></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        (function () {
            function scaleCanvasToCSS(canvas) {
                if (!canvas) return;
                var rect = canvas.getBoundingClientRect();
                var dpr = window.devicePixelRatio || 1;
                var w = Math.max(1, Math.floor(rect.width));
                var h = Math.max(1, Math.floor(rect.height));
                canvas.width = Math.floor(w * dpr);
                canvas.height = Math.floor(h * dpr);
                var ctx = canvas.getContext('2d');
                ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
                return ctx;
            }

            function truncateToWidth(ctx, text, maxWidth) {
                var t = String(text || '');
                if (maxWidth <= 0) return '';
                if (ctx.measureText(t).width <= maxWidth) return t;
                var ell = '...';
                var lo = 0;
                var hi = t.length;
                while (lo < hi) {
                    var mid = Math.ceil((lo + hi) / 2);
                    var candidate = t.slice(0, mid) + ell;
                    if (ctx.measureText(candidate).width <= maxWidth) lo = mid;
                    else hi = mid - 1;
                }
                var out = t.slice(0, lo) + ell;
                if (ctx.measureText(out).width > maxWidth) return ell;
                return out;
            }

            function safeInt(text) {
                var m = String(text || '').match(/\d+/);
                return m ? parseInt(m[0], 10) : 0;
            }

            function median(nums) {
                if (!nums.length) return 0;
                var sorted = nums.slice().sort(function (a, b) { return a - b; });
                var mid = Math.floor(sorted.length / 2);
                if (sorted.length % 2 === 0) return (sorted[mid - 1] + sorted[mid]) / 2;
                return sorted[mid];
            }

            function classify(title) {
                var t = String(title || '').toLowerCase();
                if (t.includes('economic')) return 'Economic Development';
                if (t.includes('social')) return 'Social Development';
                if (t.includes('environment')) return 'Environmental Management';
                if (t.includes('disaster')) return 'Disaster Risk & Response';
                if (t.includes('peace') || t.includes('order') || t.includes('security')) return 'Peace & Order';
                if (t.includes('health')) return 'Health & Wellness';
                if (t.includes('scholar') || t.includes('education')) return 'Education & Scholarships';
                if (t.includes('housing')) return 'Housing & Infrastructure';
                if (t.includes('procurement')) return 'Governance & Procurement';
                if (t.includes('audit')) return 'Governance & Compliance';
                if (t.includes('financial')) return 'Financial Management';
                if (t.includes('assistance')) return 'Public Assistance';
                return 'Other Programs';
            }

            var cards = Array.prototype.slice.call(document.querySelectorAll('.section-card'));
            if (!cards.length) return;

            var sections = cards.map(function (card) {
                var titleEl = card.querySelector('.section-title');
                var countEl = card.querySelector('.row-count');
                var title = titleEl ? titleEl.textContent.trim() : 'Untitled';
                var rows = safeInt(countEl ? countEl.textContent : '0');

                var onclick = card.getAttribute('onclick') || '';
                var hrefMatch = onclick.match(/'([^']+\.html)'/);
                var href = hrefMatch ? hrefMatch[1] : '';

                return { title: title, rows: rows, href: href, category: classify(title) };
            }).filter(function (s) { return s.rows > 0; });

            var totalRows = sections.reduce(function (sum, s) { return sum + s.rows; }, 0);
            var counts = sections.map(function (s) { return s.rows; });
            var avg = totalRows / (sections.length || 1);
            var med = median(counts);

            var sorted = sections.slice().sort(function (a, b) { return b.rows - a.rows; });
            var top = sorted.slice(0, 5);
            var topSum = top.reduce(function (sum, s) { return sum + s.rows; }, 0);
            var topShare = totalRows ? (topSum / totalRows) : 0;

            var insightsEl = document.getElementById('analysis-insights');
            var insightsText = '';
            insightsText += 'This budget is organized into <span class="pill pill-blue">' + sections.length + ' sections</span> with <span class="pill pill-green">' + totalRows + ' line-items</span>. ';
            insightsText += 'Most detailed area: <strong>' + (top[0] ? top[0].title : 'N/A') + '</strong>. ';
            insightsText += 'Typical section size is around <strong>' + Math.round(avg) + '</strong> rows (median: <strong>' + Math.round(med) + '</strong>). ';
            insightsText += 'Top 5 sections account for <strong>' + Math.round(topShare * 100) + '%</strong> of all line-items.';
            insightsEl.innerHTML = insightsText;

            var kpiTop = document.getElementById('kpi-top');
            var kpiTop5 = document.getElementById('kpi-top5');
            var kpiAvg = document.getElementById('kpi-avg');
            var kpiMed = document.getElementById('kpi-med');
            if (kpiTop) kpiTop.textContent = (top[0] ? (top[0].title + ' (' + top[0].rows + ' rows)') : '—');
            if (kpiTop5) kpiTop5.textContent = Math.round(topShare * 100) + '% of line-items';
            if (kpiAvg) kpiAvg.textContent = Math.round(avg) + ' rows';
            if (kpiMed) kpiMed.textContent = Math.round(med) + ' rows';

            var topList = document.getElementById('analysis-top-sections');
            topList.innerHTML = top.map(function (s, idx) {
                var pct = totalRows ? Math.round((s.rows / totalRows) * 100) : 0;
                var label = (idx + 1) + '. ' + s.title;
                var right = '<span class="pill pill-gray">' + s.rows + ' rows</span>';
                if (s.href) {
                    return '<li><a href="' + s.href + '" style="color:#2c5282; text-decoration:none; font-weight:bold;">' + label + '</a><span class="pill pill-blue">' + pct + '%</span></li>';
                }
                return '<li><span style="font-weight:bold;">' + label + '</span><span class="pill pill-blue">' + pct + '%</span></li>';
            }).join('');

            var byCat = {};
            sections.forEach(function (s) {
                byCat[s.category] = (byCat[s.category] || 0) + s.rows;
            });
            var catArr = Object.keys(byCat).map(function (k) { return { name: k, rows: byCat[k] }; });
            catArr.sort(function (a, b) { return b.rows - a.rows; });
            var focusList = document.getElementById('analysis-focus-areas');
            focusList.innerHTML = catArr.slice(0, 6).map(function (c) {
                var pct = totalRows ? Math.round((c.rows / totalRows) * 100) : 0;
                return '<li><span>' + c.name + '</span><span class="pill pill-blue">' + pct + '%</span></li>';
            }).join('');

            var distList = document.getElementById('analysis-distribution');
            var min = Math.min.apply(null, counts);
            var max = Math.max.apply(null, counts);
            distList.innerHTML = ''
                + '<li><span>Smallest section</span><span class="pill pill-gray">' + min + ' rows</span></li>'
                + '<li><span>Largest section</span><span class="pill pill-gray">' + max + ' rows</span></li>'
                + '<li><span>Average section size</span><span class="pill pill-gray">' + Math.round(avg) + ' rows</span></li>'
                + '<li><span>Median section size</span><span class="pill pill-gray">' + Math.round(med) + ' rows</span></li>';

            var bar = document.getElementById('analysis-concentration-bar');
            bar.style.width = Math.max(5, Math.min(100, Math.round(topShare * 100))) + '%';

            function drawTopBarChart() {
                var canvas = document.getElementById('chart-top');
                if (!canvas) return;
                var ctx = scaleCanvasToCSS(canvas);
                if (!ctx) return;

                var data = top.map(function (s) { return { label: s.title, value: s.rows, href: s.href }; });
                var padding = 14;
                var w = canvas.getBoundingClientRect().width;
                var h = canvas.getBoundingClientRect().height;
                ctx.clearRect(0, 0, w, h);

                var maxV = Math.max.apply(null, data.map(function (d) { return d.value; }).concat([1]));
                var rowCount = Math.max(1, data.length);
                var usableH = h - padding * 2;
                var gap = 8;
                var barH = Math.max(18, Math.min(28, Math.floor((usableH - gap * (rowCount - 1)) / rowCount)));

                var left = padding;
                var topY = padding;
                var gutter = 10;
                var labelW = Math.min(280, Math.max(170, Math.floor(w * 0.42)));
                var usableW = w - padding * 2 - labelW;
                if (usableW < 120) {
                    labelW = Math.min(180, Math.max(120, Math.floor(w * 0.32)));
                    usableW = w - padding * 2 - labelW;
                }

                ctx.font = '10px Arial';
                ctx.textBaseline = 'middle';

                data.forEach(function (d, i) {
                    var y = topY + i * (barH + gap);
                    var centerY = y + barH / 2;

                    ctx.fillStyle = '#1a365d';
                    var label = (i + 1) + '. ' + d.label;
                    label = truncateToWidth(ctx, label, Math.max(20, labelW - gutter));
                    ctx.textAlign = 'left';
                    ctx.fillText(label, left, centerY);

                    var pct = d.value / maxV;
                    var bw = Math.max(6, Math.round(usableW * pct));
                    var barX = left + labelW + gutter;
                    var barW = Math.max(1, usableW - gutter);

                    ctx.fillStyle = '#e9ecef';
                    ctx.fillRect(barX, y, barW, barH);

                    var grad = ctx.createLinearGradient(barX, y, barX + bw, y);
                    grad.addColorStop(0, '#2c5282');
                    grad.addColorStop(1, '#4a90e2');
                    ctx.fillStyle = grad;
                    ctx.fillRect(barX, y, bw, barH);

                    var valueText = d.value + ' rows';
                    ctx.font = 'bold 10px Arial';
                    var tw = ctx.measureText(valueText).width;
                    ctx.textAlign = 'right';
                    if (bw > tw + 16) {
                        ctx.fillStyle = '#ffffff';
                        ctx.fillText(valueText, barX + bw - 8, centerY);
                    } else {
                        ctx.fillStyle = '#2c5282';
                        ctx.fillText(valueText, barX + barW, centerY);
                    }
                    ctx.font = '10px Arial';
                });
            }

            function drawDonut() {
                var canvas = document.getElementById('chart-focus');
                if (!canvas) return;
                var ctx = scaleCanvasToCSS(canvas);
                if (!ctx) return;

                var w = canvas.getBoundingClientRect().width;
                var h = canvas.getBoundingClientRect().height;
                ctx.clearRect(0, 0, w, h);

                var palette = ['#2c5282', '#4a90e2', '#22c55e', '#f59e0b', '#ef4444', '#a855f7', '#14b8a6', '#64748b'];
                var data = catArr.slice(0, 6);
                var other = catArr.slice(6).reduce(function (sum, c) { return sum + c.rows; }, 0);
                if (other > 0) data = data.concat([{ name: 'Other', rows: other }]);

                var total = data.reduce(function (sum, d) { return sum + d.rows; }, 0) || 1;
                var cx = w * 0.28;
                var cy = h * 0.56;
                var rOuter = Math.min(w, h) * 0.30;
                var rInner = rOuter * 0.62;
                var start = -Math.PI / 2;

                data.forEach(function (d, i) {
                    var frac = d.rows / total;
                    var end = start + frac * Math.PI * 2;
                    ctx.beginPath();
                    ctx.moveTo(cx, cy);
                    ctx.arc(cx, cy, rOuter, start, end);
                    ctx.closePath();
                    ctx.fillStyle = palette[i % palette.length];
                    ctx.fill();
                    start = end;
                });

                ctx.globalCompositeOperation = 'destination-out';
                ctx.beginPath();
                ctx.arc(cx, cy, rInner, 0, Math.PI * 2);
                ctx.fill();
                ctx.globalCompositeOperation = 'source-over';

                ctx.fillStyle = '#1a365d';
                ctx.font = 'bold 14px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('Focus', cx, cy - 8);
                ctx.font = '11px Arial';
                ctx.fillStyle = '#495057';
                ctx.fillText('Areas', cx, cy + 10);

                ctx.textAlign = 'left';
                ctx.textBaseline = 'middle';
                ctx.font = '10px Arial';
                var lx = Math.max(w * 0.52, cx + rOuter + 18);
                var ly = h * 0.22;
                var lineH = 18;
                var pctColW = 34;
                var rightPad = 12;
                var textX = lx + 16;
                var maxLabelW = (w - rightPad - pctColW) - textX;
                if (maxLabelW < 40) {
                    // If the canvas is too narrow, push legend below donut
                    lx = 14;
                    textX = lx + 16;
                    ly = Math.min(h - 8 - lineH * 7, h * 0.70);
                    maxLabelW = (w - rightPad - pctColW) - textX;
                }
                data.slice(0, 7).forEach(function (d, i) {
                    var pct = Math.round((d.rows / total) * 100);
                    var y = ly + i * lineH;
                    ctx.fillStyle = palette[i % palette.length];
                    ctx.fillRect(lx, y - 6, 10, 10);
                    ctx.fillStyle = '#1a365d';
                    var label = truncateToWidth(ctx, d.name, maxLabelW);
                    ctx.fillText(label, textX, y);
                    ctx.textAlign = 'right';
                    ctx.fillStyle = '#495057';
                    ctx.fillText(pct + '%', w - rightPad, y);
                    ctx.textAlign = 'left';
                });
            }

            function drawDistribution() {
                var canvas = document.getElementById('chart-dist');
                if (!canvas) return;
                var ctx = scaleCanvasToCSS(canvas);
                if (!ctx) return;

                var w = canvas.getBoundingClientRect().width;
                var h = canvas.getBoundingClientRect().height;
                ctx.clearRect(0, 0, w, h);

                var minV = Math.min.apply(null, counts);
                var maxV = Math.max.apply(null, counts);
                var bins = 6;
                var range = Math.max(1, maxV - minV);
                var step = Math.ceil(range / bins) || 1;
                var hist = new Array(bins).fill(0);

                counts.forEach(function (v) {
                    var idx = Math.min(bins - 1, Math.floor((v - minV) / step));
                    hist[idx] += 1;
                });

                var maxCount = Math.max.apply(null, hist.concat([1]));
                var pad = 16;
                var usableW = w - pad * 2;
                var usableH = h - pad * 2 - 18;
                var bw = usableW / bins;

                ctx.font = '11px Arial';
                ctx.fillStyle = '#6c757d';
                ctx.textAlign = 'left';
                ctx.textBaseline = 'top';
                ctx.fillText('Smaller', pad, h - 16);
                ctx.textAlign = 'right';
                ctx.fillText('Larger', w - pad, h - 16);

                for (var i = 0; i < bins; i++) {
                    var x = pad + i * bw + 6;
                    var barW = bw - 12;
                    var bh = Math.round((hist[i] / maxCount) * usableH);
                    var y = pad + usableH - bh;

                    ctx.fillStyle = '#e9ecef';
                    ctx.fillRect(x, pad, barW, usableH);

                    ctx.fillStyle = '#2c5282';
                    ctx.fillRect(x, y, barW, bh);
                }
            }

            function renderCharts() {
                drawTopBarChart();
                drawDonut();
                drawDistribution();
            }

            renderCharts();
            window.addEventListener('resize', function () {
                window.clearTimeout(window.__budgetChartResize);
                window.__budgetChartResize = window.setTimeout(renderCharts, 120);
            });
        })();
    </script>
</body>
</html>
